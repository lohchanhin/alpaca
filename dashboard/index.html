<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<title>Alpaca Trading Dashboard</title>

<!-- Google Fonts：Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- 外部 CSS -->
<link rel="stylesheet" href="styles.css">
</head>

<body>
<h1>Alpaca Trading Dashboard</h1>

<section class="section">
    <h2>Account</h2>
    <table id="account"></table>
</section>

<section class="section">
    <h2>Positions</h2>
    <table id="positions"></table>
</section>

<section class="section">
    <h2>Orders</h2>
    <div style="margin-bottom:8px;">
        <button onclick="prevOrders()">Prev</button>
        <span id="page-info" style="margin:0 8px;">1</span>
        <button onclick="nextOrders()">Next</button>
    </div>
    <table id="orders"></table>
</section>

<section class="section">
    <h2>Bots</h2>
    <ul id="bots"></ul>
    <div style="margin-top:12px;">
        <input id="new-bot-name" placeholder="Bot name" />
        <button onclick="addBot()">Add</button>
    </div>
</section>

<script>
/* ---------- 共用渲染 ---------- */
function renderObjectTable(obj, id) {
    const table = document.getElementById(id);
    table.innerHTML = "";
    for (const [k, v] of Object.entries(obj)) {
        table.insertAdjacentHTML("beforeend",
            `<tr><th>${k}</th><td>${v}</td></tr>`);
    }
}
function renderArrayTable(arr, id) {
    const table = document.getElementById(id);
    table.innerHTML = "";
    if (!Array.isArray(arr) || arr.length === 0) return;

    const keys = Object.keys(arr[0]);
    table.insertAdjacentHTML("beforeend",
        "<thead><tr>" + keys.map(k => `<th>${k}</th>`).join("") + "</tr></thead>");
    const tbody = document.createElement("tbody");
    arr.forEach(it => {
        const row = "<tr>" + keys.map(k =>
            `<td>${typeof it[k] === "object" ? JSON.stringify(it[k]) : it[k]}</td>`).join("") + "</tr>";
        tbody.insertAdjacentHTML("beforeend", row);
    });
    table.appendChild(tbody);
}

/* ---------- API 請求 ---------- */
let orderPage = 1;
const orderLimit = 5;

async function fetchOrders(page = orderPage) {
    const ord = await fetch(`/orders?page=${page}&limit=${orderLimit}`).then(r => r.json());
    orderPage = page;
    renderArrayTable(ord, "orders");
    document.getElementById("page-info").textContent = page;
}

async function fetchData() {
    try {
        const [acct, pos] = await Promise.all([
            fetch("/account").then(r => r.json()),
            fetch("/positions").then(r => r.json())
        ]);
        renderObjectTable(acct, "account");
        renderArrayTable(pos, "positions");
        fetchOrders(orderPage);
    } catch (e) { console.error(e); }
}
async function loadBots() {
    try {
        const bots = await fetch("/bots").then(r => r.json());
        const list = document.getElementById("bots");
        list.innerHTML = "";
        bots.forEach((bot, i) => {
            list.insertAdjacentHTML("beforeend",
                `<li>
                    <input value="${bot.name || ""}" onchange="updateBot(${i}, this.value)">
                    <button onclick="deleteBot(${i})">Delete</button>
                 </li>`);
        });
    } catch (e) { console.error(e); }
}
async function addBot() {
    const name = document.getElementById("new-bot-name").value.trim();
    if (!name) return;
    await fetch("/bots", {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})});
    document.getElementById("new-bot-name").value = "";
    loadBots();
}
async function updateBot(id, name) {
    await fetch(`/bots/${id}`, {method:"PUT", headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})});
}
async function deleteBot(id) {
    await fetch(`/bots/${id}`, {method:"DELETE"});
    loadBots();
}

function prevOrders() {
    if (orderPage > 1) {
        fetchOrders(orderPage - 1);
    }
}

function nextOrders() {
    fetchOrders(orderPage + 1);
}

/* ---------- INIT ---------- */
fetchData();
loadBots();
setInterval(fetchData, 10000);   // 每 10 秒更新一次
</script>
</body>
</html>
