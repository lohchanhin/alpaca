<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>Alpaca Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 20px; }
        pre { background: #f4f4f4; padding: 10px; }
    </style>
</head>
<body>
    <h1>Alpaca Trading Dashboard</h1>
    <div id="loading" style="display:none;">載入中...</div>
    <div id="error" style="display:none;color:red;"></div>

    <div class="section">
        <h2>Account</h2>
        <pre id="account">載入中...</pre>
    </div>

    <div class="section">
        <h2>Positions</h2>
        <pre id="positions">載入中...</pre>
    </div>

    <div class="section">
        <h2>Orders</h2>
        <pre id="orders">載入中...</pre>
    </div>

    <div class="section">
        <h2>Bots</h2>
        <ul id="bots"></ul>
        <input id="new-bot-name" placeholder="Bot name">
        <button onclick="addBot()">Add</button>
    </div>

    <script>
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');

    function showLoading() {
        loadingEl.style.display = 'block';
    }

    function hideLoading() {
        loadingEl.style.display = 'none';
    }

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
    }

    function clearError() {
        errorEl.textContent = '';
        errorEl.style.display = 'none';
    }

    async function fetchData() {
        showLoading();
        clearError();
        try {
            const [accountResp, positionsResp, ordersResp] = await Promise.all([
                fetch('/account'),
                fetch('/positions'),
                fetch('/orders?limit=5')
            ]);
            if (!accountResp.ok || !positionsResp.ok || !ordersResp.ok) {
                throw new Error('Fetch failed');
            }
            const account = await accountResp.json();
            const positions = await positionsResp.json();
            const orders = await ordersResp.json();
            document.getElementById('account').textContent = JSON.stringify(account, null, 2);
            document.getElementById('positions').textContent = JSON.stringify(positions, null, 2);
            document.getElementById('orders').textContent = JSON.stringify(orders, null, 2);
        } catch (err) {
            console.error(err);
            showError('資料載入失敗');
        } finally {
            hideLoading();
        }
    }

    async function loadBots() {
        showLoading();
        clearError();
        try {
            const resp = await fetch('/bots');
            if (!resp.ok) {
                throw new Error('Fetch failed');
            }
            const bots = await resp.json();
            const list = document.getElementById('bots');
            list.innerHTML = '';
            bots.forEach((bot, idx) => {
                const li = document.createElement('li');
                const input = document.createElement('input');
                input.value = bot.name || '';
                input.onchange = () => updateBot(idx, {name: input.value});
                li.appendChild(input);
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.onclick = () => deleteBot(idx);
                li.appendChild(delBtn);
                list.appendChild(li);
            });
        } catch (err) {
            console.error(err);
            showError('無法載入機器人資料');
        } finally {
            hideLoading();
        }
    }

    async function addBot() {
        const name = document.getElementById('new-bot-name').value;
        await fetch('/bots', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        document.getElementById('new-bot-name').value = '';
        loadBots();
    }

    async function updateBot(id, bot) {
        await fetch(`/bots/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(bot)
        });
    }

    async function deleteBot(id) {
        await fetch(`/bots/${id}`, {method: 'DELETE'});
        loadBots();
    }

    fetchData();
    loadBots();
    setInterval(fetchData, 10000);
    </script>
</body>
</html>
