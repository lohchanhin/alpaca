<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<title>Alpaca Trading Dashboard</title>

<!-- Google Fonts：Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- 外部 CSS -->
<link rel="stylesheet" href="styles.css">
</head>

<body>
<h1>Alpaca Trading Dashboard</h1>

<section class="section">
    <h2>Account</h2>
    <table id="account"></table>
</section>

<section class="section">
    <h2>Positions</h2>
    <table id="positions"></table>
</section>

<section class="section">
    <h2>Orders (latest 5)</h2>
    <table id="orders"></table>
</section>

<section class="section">
    <h2>Bots</h2>
    <ul id="bots"></ul>
    <div style="margin-top:12px;">
        <input id="new-bot-name" placeholder="Bot name" />
        <button onclick="addBot()">Add</button>
    </div>
</section>

<script>
/* ---------- 共用渲染 ---------- */
function renderObjectTable(obj, id) {
    const table = document.getElementById(id);
    table.innerHTML = "";
    for (const [k, v] of Object.entries(obj)) {
        table.insertAdjacentHTML("beforeend",
            `<tr><th>${k}</th><td>${v}</td></tr>`);
    }
}
function renderArrayTable(arr, id, fields) {
    const table = document.getElementById(id);
    table.innerHTML = "";
    if (!Array.isArray(arr) || arr.length === 0) return;

    const keys = fields ?? Object.keys(arr[0]);
    table.insertAdjacentHTML(
        "beforeend",
        "<thead><tr>" + keys.map(k => `<th>${k}</th>`).join("") + "</tr></thead>"
    );
    const tbody = document.createElement("tbody");
    arr.forEach(it => {
        const row =
            "<tr>" +
            keys
                .map(k => `<td>${typeof it[k] === "object" ? JSON.stringify(it[k]) : it[k]}</td>`)
                .join("") +
            "</tr>";
        tbody.insertAdjacentHTML("beforeend", row);
    });
    table.appendChild(tbody);
}

/* ---------- API 請求 ---------- */
async function fetchData() {
    try {
        const [acct, pos, ord] = await Promise.all([
            fetch("/account").then(r => r.json()),
            fetch("/positions").then(r => r.json()),
            fetch("/orders?limit=5").then(r => r.json())
        ]);

        const posData = (pos || []).map(p => {
            const avg = parseFloat(p.avg_entry_price);
            const cur = parseFloat(p.current_price);
            const pct = avg ? (((cur - avg) / avg) * 100).toFixed(2) : "0";
            return {
                symbol: p.symbol,
                qty: p.qty,
                avg_price: p.avg_entry_price,
                current_price: p.current_price,
                "%": pct
            };
        });

        const ordData = (ord || []).map(o => ({
            id: o.id,
            symbol: o.symbol,
            side: o.side,
            qty: o.qty,
            price: o.filled_avg_price
        }));

        renderObjectTable(acct, "account");
        renderArrayTable(posData, "positions", ["symbol", "qty", "avg_price", "current_price", "%"]);
        renderArrayTable(ordData, "orders", ["id", "symbol", "side", "qty", "price"]);
    } catch (e) { console.error(e); }
}
async function loadBots() {
    try {
        const bots = await fetch("/bots").then(r => r.json());
        const list = document.getElementById("bots");
        list.innerHTML = "";
        bots.forEach((bot, i) => {
            list.insertAdjacentHTML("beforeend",
                `<li>
                    <input value="${bot.name || ""}" onchange="updateBot(${i}, this.value)">
                    <button onclick="deleteBot(${i})">Delete</button>
                 </li>`);
        });
    } catch (e) { console.error(e); }
}
async function addBot() {
    const name = document.getElementById("new-bot-name").value.trim();
    if (!name) return;
    await fetch("/bots", {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})});
    document.getElementById("new-bot-name").value = "";
    loadBots();
}
async function updateBot(id, name) {
    await fetch(`/bots/${id}`, {method:"PUT", headers:{'Content-Type':'application/json'}, body:JSON.stringify({name})});
}
async function deleteBot(id) {
    await fetch(`/bots/${id}`, {method:"DELETE"});
    loadBots();
}

/* ---------- INIT ---------- */
fetchData();
loadBots();
setInterval(fetchData, 10000);   // 每 10 秒更新一次
</script>
</body>
</html>
